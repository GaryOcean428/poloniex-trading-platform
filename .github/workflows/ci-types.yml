name: Comprehensive QA Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**/*.ts'
      - 'backend/**/*.js'
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'backend/package.json'
      - 'frontend/package.json'
      - 'package.json'
      - 'yarn.lock'
      - 'backend/tsconfig.json'
      - 'frontend/tsconfig.json'
      - 'tsconfig.json'
      - '.github/workflows/**'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check dependency health
        run: yarn deps:health
        continue-on-error: true

  type-check:
    runs-on: ubuntu-latest
    needs: dependency-check
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: TypeScript check - Backend
        run: yarn workspace backend tsc --noEmit
        continue-on-error: false

      - name: TypeScript check - Frontend
        run: yarn workspace frontend tsc --noEmit
        continue-on-error: false

  lint-check:
    runs-on: ubuntu-latest
    needs: type-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint check - Backend
        run: yarn workspace backend lint
        continue-on-error: false

      - name: Lint check - Frontend
        run: yarn workspace frontend lint
        continue-on-error: false

  build-check:
    runs-on: ubuntu-latest
    needs: [type-check, lint-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build backend
        run: yarn workspace backend build

      - name: Build frontend
        run: yarn workspace frontend build

  test-check:
    runs-on: ubuntu-latest
    needs: build-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Test backend
        run: yarn workspace backend test:run
        continue-on-error: true

      - name: Test frontend
        run: yarn workspace frontend test:run
        continue-on-error: true

  security-audit:
    runs-on: ubuntu-latest
    needs: [type-check, lint-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Security audit
        run: yarn audit --level moderate
        continue-on-error: true

      - name: Run custom security checks
        run: yarn security:audit
        continue-on-error: true

  railway-validation:
    runs-on: ubuntu-latest
    needs: build-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Validate Railway configuration
        run: yarn railway:validate
        continue-on-error: true

      - name: Check workspace health
        run: yarn workspace:health
        continue-on-error: true

  comprehensive-qa:
    runs-on: ubuntu-latest
    needs: [test-check, security-audit, railway-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'yarn'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run comprehensive quality check
        run: yarn quality:check
        continue-on-error: true

      - name: QA Summary
        run: |
          echo "ðŸŽ‰ Comprehensive QA Pipeline Complete!"
          echo "âœ… Dependencies checked"
          echo "âœ… TypeScript compilation verified"
          echo "âœ… Linting completed"
          echo "âœ… Build successful"
          echo "âœ… Tests executed"
          echo "âœ… Security audit performed"
          echo "âœ… Railway configuration validated"
